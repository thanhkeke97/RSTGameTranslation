name: Build & Release RST

on:
  workflow_dispatch: 

jobs:
  build-and-package:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET 9
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 9.0.x

    - name: Install Windows SDK with UAP
      shell: powershell
      run: |
        $sdkUrl = "https://go.microsoft.com/fwlink/?linkid=2120843"
        $installerPath = "$env:TEMP\winsdksetup.exe"
        Write-Host "Downloading Windows SDK..."
        Invoke-WebRequest -Uri $sdkUrl -OutFile $installerPath
        Write-Host "Installing Windows SDK (this may take a few minutes)..."
        Start-Process -FilePath $installerPath -ArgumentList "/features OptionId.UWPCpp /quiet /norestart" -Wait
        Write-Host "Windows SDK installation completed."

    - name: Setup Node.js (for version script)
      uses: actions/setup-node@v4
      with:
        node-version: 18

    - name: Run Update Version Script
      run: node update-version.js

    - name: Publish .NET App
      run: dotnet publish RST.csproj -c Release -r win-x64 -p:PublishSingleFile=true --self-contained true

    - name: Sign rst.exe with SignPath
      shell: powershell
      env:
      SIGNPATH_API_TOKEN: ${{ secrets.SIGNPATH_API_TOKEN }}
      SIGNPATH_ORG_ID: ${{ secrets.SIGNPATH_ORG_ID }}
      SIGNPATH_PROJECT_SLUG: ${{ secrets.SIGNPATH_PROJECT_SLUG }}
      SIGNPATH_SIGNING_POLICY_SLUG: ${{ secrets.SIGNPATH_SIGNING_POLICY_SLUG }}
      SIGNPATH_ARTIFACT_CONFIG_SLUG: ${{ secrets.SIGNPATH_ARTIFACT_CONFIG_SLUG }}
      run: |
      Write-Host "Searching for rst.exe to sign..."
      $exe = Get-ChildItem -Path . -Filter "rst.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
      if (-not $exe) {
        Write-Host "ERROR: rst.exe not found in workspace."
        exit 1
      }

      if (-not $env:SIGNPATH_API_TOKEN) {
        Write-Host "ERROR: SIGNPATH_API_TOKEN not set. Add it to repository secrets."
        exit 1
      }

      $org = $env:SIGNPATH_ORG_ID
      $token = $env:SIGNPATH_API_TOKEN
      $project = $env:SIGNPATH_PROJECT_SLUG
      $policy = $env:SIGNPATH_SIGNING_POLICY_SLUG
      $artifactConfig = $env:SIGNPATH_ARTIFACT_CONFIG_SLUG

      $submitUrl = "https://app.signpath.io/API/v1/$org/SigningRequests/SubmitWithArtifact"
      $headers = @{ Authorization = "Bearer $token" }

      $form = @{
        projectSlug = $project
        signingPolicySlug = $policy
        artifact = Get-Item $exe.FullName
      }
      if ($artifactConfig) { $form['artifactConfigurationSlug'] = $artifactConfig }

      Write-Host "Submitting signing request for $($exe.FullName) to SignPath..."
      $resp = Invoke-WebRequest -Uri $submitUrl -Method Post -Headers $headers -Form $form -UseBasicParsing -ErrorAction Stop
      if ($resp.StatusCode -ne 201) {
        Write-Host "SignPath submission failed: $($resp.StatusCode)"
        Write-Host $resp.Content
        exit 1
      }

      $location = $resp.Headers['Location']
      Write-Host "Signing request created: $location"
      $signingRequestId = ($location -split '/')[-1]

      $checkUrl = "https://app.signpath.io/API/v1/$org/SigningRequests/$signingRequestId"
      $statusResp = $null
      for ($i=0; $i -lt 120; $i++) {
        Start-Sleep -Seconds 5
        $statusResp = Invoke-RestMethod -Uri $checkUrl -Headers $headers -Method Get -ErrorAction Stop
        Write-Host "Status: $($statusResp.status) - $($statusResp.workflowStatus)"
        if ($statusResp.isFinalStatus -eq $true) { break }
      }

      if ($statusResp.status -ne 'Completed') {
        Write-Host "Signing did not complete successfully: $($statusResp.status)"
        exit 1
      }

      $signedLink = $statusResp.signedArtifactLink
      Write-Host "Downloading signed artifact from $signedLink"
      $outPath = Join-Path -Path (Split-Path $exe.FullName) -ChildPath ($exe.BaseName + "-signed" + $exe.Extension)
      Invoke-WebRequest -Uri $signedLink -Headers $headers -OutFile $outPath -UseBasicParsing -ErrorAction Stop
      Write-Host "Signed artifact saved to $outPath"

      # Replace original executable with signed one
      Move-Item -Path $outPath -Destination $exe.FullName -Force
      Write-Host "Replaced original executable with signed artifact."

    - name: Prepare Release Folder Structure
      shell: powershell
      run: |
        $releaseDir = "RSTGameTranslation"
        
        New-Item -ItemType Directory -Force -Path $releaseDir
        $dirs = @(
            "webserver\EasyOCR", 
            "webserver\PaddleOCR", 
            "webserver\RapidOCR", 
            "webserver\Python311", 
            "translation_server\templates", 
            "AudioModel", 
            "Languages"
        )
        foreach ($d in $dirs) { New-Item -ItemType Directory -Force -Path "$releaseDir\$d" }

        # Copy file build ch√≠nh
        if (Test-Path "app\win-x64\publish") {
            Copy-Item -Path "app\win-x64\publish\*" -Destination $releaseDir -Recurse -Force
        } else {
            Write-Host "ERROR: Build output not found at app\win-x64\publish"
            exit 1
        }

        # README
        if (Test-Path "README.md") { Copy-Item "README.md" -Destination $releaseDir }

        # Webserver & OCR Scripts
        if (Test-Path "app\webserver\EasyOCR") {
            Get-ChildItem "app\webserver\EasyOCR\*" -Include *.py,*.bat -ErrorAction SilentlyContinue | Copy-Item -Destination "$releaseDir\webserver\EasyOCR"
        }
        if (Test-Path "app\webserver\PaddleOCR") {
            Get-ChildItem "app\webserver\PaddleOCR\*" -Include *.py,*.bat -ErrorAction SilentlyContinue | Copy-Item -Destination "$releaseDir\webserver\PaddleOCR"
        }
        if (Test-Path "app\webserver\RapidOCR") {
            Get-ChildItem "app\webserver\RapidOCR\*" -Include *.py,*.bat -ErrorAction SilentlyContinue | Copy-Item -Destination "$releaseDir\webserver\RapidOCR"
        }
        if (Test-Path "app\webserver\*.bat") {
            Copy-Item "app\webserver\*.bat" -Destination "$releaseDir\webserver" -ErrorAction SilentlyContinue
        }

        # Translation Server
        if (Test-Path "app\translation_server") {
            Get-ChildItem "app\translation_server\*" -Include *.py,*.bat -ErrorAction SilentlyContinue | Copy-Item -Destination "$releaseDir\translation_server"
            if (Test-Path "app\translation_server\templates") {
                Copy-Item "app\translation_server\templates\*.html" -Destination "$releaseDir\translation_server\templates" -ErrorAction SilentlyContinue
            }
        } else {
            Write-Host "Warning: translation_server folder not found. Skipping."
        }

        # OneOcr 
        if (Test-Path "app\OneOcr") { 
            Copy-Item "app\OneOcr\*" -Destination $releaseDir -ErrorAction SilentlyContinue
        }

        # Download Python 3.11 Embedded
        $pythonUrl = "https://www.python.org/ftp/python/3.11.9/python-3.11.9-embed-amd64.zip"
        $pythonZip = "$env:TEMP\python311.zip"
        $pythonDest = "$releaseDir\webserver\Python311"
        Write-Host "Downloading Python 3.11 Embedded..."
        Invoke-WebRequest -Uri $pythonUrl -OutFile $pythonZip
        Write-Host "Extracting Python 3.11..."
        Expand-Archive -Path $pythonZip -DestinationPath $pythonDest -Force

        Write-Host "Downloading get-pip.py..."
        Invoke-WebRequest -Uri "https://bootstrap.pypa.io/get-pip.py" -OutFile "$pythonDest\get-pip.py"
        
        $pthFile = "$pythonDest\python311._pth"
        if (Test-Path $pthFile) {
            (Get-Content $pthFile) -replace '#import site', 'import site' | Set-Content $pthFile
        }

        # Audio Model - Download from URL
        $modelUrl = "https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-tiny.bin?download=true"
        $modelDest = "$releaseDir\AudioModel\ggml-tiny.bin"
        Write-Host "Downloading Audio Model from HuggingFace..."
        Invoke-WebRequest -Uri $modelUrl -OutFile $modelDest

        # Languages
        if (Test-Path "app\Languages") {
            Copy-Item "app\Languages\*" -Destination "$releaseDir\Languages" -Recurse -ErrorAction SilentlyContinue
        } else {
            Write-Host "Warning: Languages folder not found. Skipping."
        }

        Write-Host "=== Release folder contents ==="
        Get-ChildItem -Path $releaseDir -Recurse | Select-Object FullName

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: RSTGameTranslation
        path: RSTGameTranslation/*
        compression-level: 9